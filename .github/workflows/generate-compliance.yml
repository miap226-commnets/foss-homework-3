name: FOSS Homework Automation

on: [push, workflow_dispatch]

jobs:
  generate-files:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download zlib Source Code
        run: |
          wget --user-agent="Mozilla/5.0" https://www.zlib.net/zlib-1.3.1.tar.gz
          tar -xzvf zlib-1.3.1.tar.gz
          mv zlib-1.3.1 source_code

      - name: Generate SBOM with Syft
        uses: anchore/sbom-action@v0
        with:
          path: ./source_code
          format: spdx-json
          output-file: zlib_sbom.spdx.json

      # Step 3: ç»Ÿè®¡æ•°é‡ (æ¸…æ´—ç‰ˆ)
      - name: Count Distinct Copyright Notices
        id: count_copyrights
        run: |
          echo "å¼€å§‹è¿›è¡Œå¼ºåŠ›æ¸…æ´—å’Œå»é‡ç»Ÿè®¡..."
          
          # 1. grep: å¼ºåˆ¶è¦æ±‚å¹´ä»½åå¿…é¡»æœ‰å­—æ¯ (è¿‡æ»¤æ‰ 'Copyright (c) 1997' è¿™ç§æ— æ•ˆå£°æ˜)
          # 2. sed é“¾: ç»Ÿä¸€æ ¼å¼ï¼Œå»æ‰ (c), all rights reserved, æ ‡ç‚¹ç¬¦å·ç­‰
          
          grep -r -i -h -E "Copyright.*[0-9]{4}.*[a-zA-Z]" ./source_code \
            | sed -E 's/<[^>]*>//g' \
            | sed -E 's/[*#";\\]//g' \
            | sed -E 's/&amp;/&/g' \
            | sed -E 's/&#169;/(C)/g' \
            | sed -E 's/Copyright.*[:>]/Copyright /' \
            | sed -E 's/[(][cC][)]//g' \
            | sed -E 's/ by / /g' \
            | sed -E 's/all rights reserved//Ig' \
            | sed -E 's/[,.]\s*$//' \
            | sed -E 's/\s+/ /g; s/^\s+|\s+$//g' \
            | sort -u -f > cleaned_notices.txt
          
          DISTINCT_COUNT=$(wc -l < cleaned_notices.txt)
          
          echo "============================================"
          echo "FINAL DISTINCT COUNT: $DISTINCT_COUNT"
          echo "============================================"
          
          echo "### ğŸ“Š æœ€ç»ˆç»Ÿè®¡ç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "- **Distinct Copyright Occurrences**: $DISTINCT_COUNT" >> $GITHUB_STEP_SUMMARY

      # Step 4: ç”Ÿæˆæ–‡ä»¶ (é€»è¾‘å¿…é¡»ä¸ Step 3 å®Œå…¨ä¸€è‡´)
      - name: Generate Legal Notices File
        run: |
          echo "FOSS Homework 3 - Legal Notices" > LEGAL_NOTICES.txt
          echo "Student Matrikelnummer: (Fill in your ID)" >> LEGAL_NOTICES.txt
          echo "Project: zlib 1.3.1" >> LEGAL_NOTICES.txt
          echo "Tool used: GitHub Actions (Syft + grep/sed/sort deep clean)" >> LEGAL_NOTICES.txt
          echo "---------------------------------------------------" >> LEGAL_NOTICES.txt
          echo "" >> LEGAL_NOTICES.txt
          
          echo "DISTINCT COPYRIGHT NOTICES FOUND (NORMALIZED):" >> LEGAL_NOTICES.txt
          # [æ ¸å¿ƒä¿®æ”¹] è¿™é‡Œç›´æ¥ä½¿ç”¨ Step 3 ç”Ÿæˆçš„ cleaned_notices.txt
          # è¿™æ ·ä¿è¯äº†æ–‡ä»¶é‡Œåˆ—å‡ºçš„åˆ—è¡¨ï¼Œå’Œä¸Šé¢ç»Ÿè®¡çš„æ•°å­—æ˜¯ä¸¥æ ¼å¯¹åº”çš„
          cat cleaned_notices.txt >> LEGAL_NOTICES.txt
          
          echo "" >> LEGAL_NOTICES.txt
          echo "---------------------------------------------------" >> LEGAL_NOTICES.txt
          echo "RAW SCAN DETAILS (Reference only):" >> LEGAL_NOTICES.txt
          # ä¿ç•™åŸå§‹æ‰«æä½œä¸ºå‚è€ƒï¼Œè¯æ˜ä½ æ²¡æœ‰é—æ¼ï¼Œåªæ˜¯åšäº†æ¸…æ´—
          grep -r -i -E "Copyright.*[0-9]{4}" ./source_code >> LEGAL_NOTICES.txt
          
          echo "" >> LEGAL_NOTICES.txt
          echo "--- Full License Context from README ---" >> LEGAL_NOTICES.txt
          cat ./source_code/README >> LEGAL_NOTICES.txt

      - name: Upload Homework Files
        uses: actions/upload-artifact@v4
        with:
          name: homework-submission-files
          path: |
            zlib_sbom.spdx.json
            LEGAL_NOTICES.txt
