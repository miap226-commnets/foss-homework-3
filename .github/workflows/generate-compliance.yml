name: FOSS Homework Automation

on: [push, workflow_dispatch]

jobs:
  generate-files:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # 1. ä¸‹è½½ä½œä¸šæŒ‡å®šçš„ Zlib æºç 
      - name: Download zlib Source Code
        run: |
          wget https://www.zlib.net/zlib-1.3.1.tar.gz
          tar -xzvf zlib-1.3.1.tar.gz
          mv zlib-1.3.1 source_code

      # 2. ç”Ÿæˆ SBOM (SPDX 2.3 æ ¼å¼) - å¯¹åº”ä½œä¸šè¦æ±‚
      - name: Generate SBOM with Syft
        uses: anchore/sbom-action@v0
        with:
          path: ./source_code
          format: spdx-json
          output-file: zlib_sbom.spdx.json

      # 3. ç»Ÿè®¡ç‰ˆæƒæ•°é‡ - å¯¹åº” Google Form é—®é¢˜
      - name: Count Copyright Occurrences
        id: count_copyrights
        run: |
          echo "å¼€å§‹ç»Ÿè®¡ Copyright æ•°é‡..."
          # ä½¿ç”¨ grep é€’å½’æŸ¥æ‰¾ "Copyright"ï¼Œä¸åŒºåˆ†å¤§å°å†™
          COUNT=$(grep -r -i "Copyright" ./source_code | wc -l)
          echo "============================================"
          echo "COPYRIGHT_COUNT: $COUNT"
          echo "============================================"
          # è¿™ä¸€æ­¥æ˜¯ä¸ºäº†è®©ä½ åœ¨æ€»ç»“é¡µé¢èƒ½ç›´æŽ¥çœ‹åˆ°ç»“æžœ
          echo "### ðŸ“Š ç»Ÿè®¡ç»“æžœ (å¡«å…¥ Google Form)" >> $GITHUB_STEP_SUMMARY
          echo "- **Copyright Occurrences**: $COUNT" >> $GITHUB_STEP_SUMMARY

      # 4. ç”Ÿæˆ Legal Notices æ–‡ä»¶ - å¯¹åº” Moodle ä½œä¸šè¦æ±‚
      - name: Generate Legal Notices File
        run: |
          echo "FOSS Homework 3 - Legal Notices" > LEGAL_NOTICES.txt
          echo "Student Matrikelnummer: (Fill in your ID)" >> LEGAL_NOTICES.txt
          echo "Project: zlib 1.3.1" >> LEGAL_NOTICES.txt
          echo "Tool used: GitHub Actions (Syft + grep)" >> LEGAL_NOTICES.txt
          echo "---------------------------------------------------" >> LEGAL_NOTICES.txt
          echo "" >> LEGAL_NOTICES.txt
          
          echo "LICENSE TEXT & COPYRIGHTS:" >> LEGAL_NOTICES.txt
          # æå–æºç ä¸­çš„ Copyright ä¿¡æ¯
          grep -r -i "Copyright" ./source_code >> LEGAL_NOTICES.txt
          echo "" >> LEGAL_NOTICES.txt
          echo "--- Full License Context from README ---" >> LEGAL_NOTICES.txt
          # Zlib çš„è®¸å¯è¯é€šå¸¸åœ¨ README ä¸­
          cat ./source_code/README >> LEGAL_NOTICES.txt

      # 5. æ‰“åŒ…æ–‡ä»¶ä¾›ä¸‹è½½
      - name: Upload Homework Files
        uses: actions/upload-artifact@v4
        with:
          name: homework-submission-files
          path: |
            zlib_sbom.spdx.json
            LEGAL_NOTICES.txt
