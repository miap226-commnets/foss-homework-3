name: FOSS Homework Automation

on: [push, workflow_dispatch]

jobs:
  generate-files:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download zlib Source Code
        run: |
          wget --user-agent="Mozilla/5.0" https://www.zlib.net/zlib-1.3.1.tar.gz
          tar -xzvf zlib-1.3.1.tar.gz
          mv zlib-1.3.1 source_code

      - name: Generate SBOM with Syft
        uses: anchore/sbom-action@v0
        with:
          path: ./source_code
          format: spdx-json
          output-file: zlib_sbom.spdx.json

      # 3. [Python å¼•æ“] æ™ºèƒ½ç»Ÿè®¡ (å®Œç¾è§£å†³è·¨è¡Œã€é‡å¤ã€æ ¼å¼æ¸…æ´—)
      - name: Count Distinct Copyright Notices
        id: count_copyrights
        run: |
          echo "å¯åŠ¨ Python æ‰«æå¼•æ“..."
          
          # å°† Python è„šæœ¬å†™å…¥ä¸´æ—¶æ–‡ä»¶ scan.py
          cat << 'EOF' > scan.py
          import os
          import re

          root_dir = './source_code'
          notices = set()

          # æ­£åˆ™è§£é‡Šï¼š
          # 1. Copyright : é”šç‚¹
          # 2. [^0-9a-zA-Z]*? : éè´ªå©ªåŒ¹é…ä¸­é—´çš„æ‚è´¨ (æ¢è¡Œã€*ã€æ³¨é‡Šç¬¦ã€ç©ºæ ¼ã€(c)ç­‰)
          # 3. ((?:19|20)\d{2}.*?) : æ•è·ç»„ï¼ŒåŒ¹é… 19xx æˆ– 20xx å¼€å¤´çš„å¹´ä»½åŠå…¶åçš„ä½œè€…
          # 4. (?:\r|\n|$) : åŒ¹é…åˆ°è¡Œå°¾
          # re.DOTALL : è®©ç‚¹å·(.)å¯ä»¥åŒ¹é…æ¢è¡Œç¬¦ (å…³é”®ï¼è§£å†³è·¨è¡Œé—®é¢˜)
          
          regex = re.compile(r'Copyright[^0-9a-zA-Z]*?((?:19|20)\d{2}.*?)(?:\r|\n|$)', re.IGNORECASE | re.DOTALL)

          for subdir, dirs, files in os.walk(root_dir):
              for file in files:
                  filepath = os.path.join(subdir, file)
                  try:
                      with open(filepath, 'r', errors='ignore') as f:
                          content = f.read()
                          
                          # æ‰«ææ‰€æœ‰åŒ¹é…é¡¹
                          for match in regex.finditer(content):
                              # æå–å‡ºçš„æ ¸å¿ƒå†…å®¹ (å¹´ä»½ + ä½œè€…)
                              raw_body = match.group(1)
                              
                              # é‡æ–°æ‹¼æ¥æ ‡å‡†å¤´
                              full_text = "Copyright " + raw_body
                              
                              # === å¼ºåŠ›æ¸…æ´—é€»è¾‘ (ç§»æ¤è‡ªä¹‹å‰çš„ sed) ===
                              # 1. å»æ‰ HTML æ ‡ç­¾ã€ä»£ç ç¬¦å·
                              clean = re.sub(r'<[^>]*>', '', full_text)
                              clean = re.sub(r'[*#";\\]', '', clean)
                              # 2. ä¿®å¤ HTML è½¬ä¹‰
                              clean = re.sub(r'&amp;', '&', clean)
                              clean = re.sub(r'&#169;', '(C)', clean)
                              # 3. ç»Ÿä¸€ (C) å’Œ By
                              clean = re.sub(r'\(c\)', '', clean, flags=re.IGNORECASE)
                              clean = re.sub(r'\s+by\s+', ' ', clean, flags=re.IGNORECASE)
                              # 4. ç»Ÿä¸€å…¬å¸æ‹¼å†™ (Borland Corp -> Corporation)
                              clean = re.sub(r'Corp\.', 'Corporation', clean, flags=re.IGNORECASE)
                              # 5. å»æ‰ "All rights reserved"
                              clean = re.sub(r'all rights reserved', '', clean, flags=re.IGNORECASE)
                              # 6. å»æ‰è¡Œå°¾æ ‡ç‚¹å’Œå‰åç©ºæ ¼
                              clean = re.sub(r'[,.]\s*$', '', clean)
                              clean = re.sub(r'\s+', ' ', clean).strip()
                              
                              # è¿‡æ»¤é€»è¾‘ï¼š
                              # 1. å¿…é¡»åŒ…å«è‡³å°‘ä¸€ä¸ªå­—æ¯ (è¿‡æ»¤ 'Copyright 1997')
                              # 2. ä¸èƒ½åŒ…å« URL (è¿‡æ»¤ 'Copyright ... .html')
                              if re.search(r'[a-zA-Z]', clean) and not re.search(r'http|//|html', clean, re.IGNORECASE):
                                  notices.add(clean)
                                  
                  except Exception:
                      pass

          # è¾“å‡ºç»“æœåˆ°æ–‡ä»¶
          with open('cleaned_notices.txt', 'w') as f:
              for n in sorted(notices):
                  f.write(n + '\n')
          EOF
          
          # è¿è¡Œ Python è„šæœ¬
          python3 scan.py
          
          # ç»Ÿè®¡è¡Œæ•°
          DISTINCT_COUNT=$(wc -l < cleaned_notices.txt)
          
          echo "============================================"
          echo "FINAL DISTINCT COUNT: $DISTINCT_COUNT"
          echo "============================================"
          
          echo "### ğŸ“Š æœ€ç»ˆç»Ÿè®¡ç»“æœ (Python Powered)" >> $GITHUB_STEP_SUMMARY
          echo "- **Distinct Copyright Occurrences**: $DISTINCT_COUNT" >> $GITHUB_STEP_SUMMARY

      # 4. ç”Ÿæˆæ–‡ä»¶
      - name: Generate Legal Notices File
        run: |
          echo "FOSS Homework 3 - Legal Notices" > LEGAL_NOTICES.txt
          echo "Student Matrikelnummer: (Fill in your ID)" >> LEGAL_NOTICES.txt
          echo "Project: zlib 1.3.1" >> LEGAL_NOTICES.txt
          echo "Tool used: GitHub Actions (Custom Python Script for multiline regex & normalization)" >> LEGAL_NOTICES.txt
          echo "---------------------------------------------------" >> LEGAL_NOTICES.txt
          echo "" >> LEGAL_NOTICES.txt
          
          echo "DISTINCT COPYRIGHT NOTICES FOUND (NORMALIZED):" >> LEGAL_NOTICES.txt
          # ç›´æ¥è¯»å– Python ç”Ÿæˆçš„å®Œç¾æ–‡ä»¶
          cat cleaned_notices.txt >> LEGAL_NOTICES.txt
          
          echo "" >> LEGAL_NOTICES.txt
          echo "---------------------------------------------------" >> LEGAL_NOTICES.txt
          echo "RAW SCAN DETAILS (Reference only):" >> LEGAL_NOTICES.txt
          # ç®€å• grep ä½œä¸ºå‚è€ƒ
          grep -r -i -E "Copyright.*[0-9]{4}" ./source_code >> LEGAL_NOTICES.txt
          
          echo "" >> LEGAL_NOTICES.txt
          echo "--- Full License Context from README ---" >> LEGAL_NOTICES.txt
          cat ./source_code/README >> LEGAL_NOTICES.txt

      - name: Upload Homework Files
        uses: actions/upload-artifact@v4
        with:
          name: homework-submission-files
          path: |
            zlib_sbom.spdx.json
            LEGAL_NOTICES.txt
