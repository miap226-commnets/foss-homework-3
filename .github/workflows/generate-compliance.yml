name: FOSS Homework Automation

on: [push, workflow_dispatch]

jobs:
  generate-files:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # 1. ä¸‹è½½æºç  (å¸¦ User-Agent ä¼ªè£…)
      - name: Download zlib Source Code
        run: |
          wget --user-agent="Mozilla/5.0" https://www.zlib.net/zlib-1.3.1.tar.gz
          tar -xzvf zlib-1.3.1.tar.gz
          mv zlib-1.3.1 source_code

      # 2. ç”Ÿæˆ SBOM
      - name: Generate SBOM with Syft
        uses: anchore/sbom-action@v0
        with:
          path: ./source_code
          format: spdx-json
          output-file: zlib_sbom.spdx.json

      # 3. [ç»ˆæä¼˜åŒ–] ç»Ÿè®¡â€œä¸é‡å¤â€çš„ç‰ˆæƒå£°æ˜ (Deep Clean & Distinct Count)
      - name: Count Distinct Copyright Notices
        id: count_copyrights
        run: |
          echo "å¼€å§‹ç»Ÿè®¡å¹¶æ¸…æ´— DISTINCT Copyright æ•°é‡..."
          
          # é€»è¾‘è§£æï¼š
          # 1. grep ...: æå–åŸå§‹è¡Œ
          # 2. sed -E: è¿›è¡Œæ·±åº¦æ¸…æ´—
          #    - s/&amp;/&/g: ä¿®å¤ HTML è½¬ä¹‰ç¬¦
          #    - s/&#169;/(C)/g: ä¿®å¤ HTML ç‰ˆæƒç¬¦
          #    - s/&/and/g: ç»Ÿä¸€ & ä¸º and
          #    - s/ by / /g: å»æ‰ "by"
          #    - s/[";\\]|\\n|\\0|<[^>]*>//g: å»æ‰ä»£ç ç¬¦å· (", ;, \, \n, \0, XMLæ ‡ç­¾)
          #    - s/\s+/ /g: æŠŠå¤šä¸ªç©ºæ ¼å˜æˆä¸€ä¸ªç©ºæ ¼
          #    - s/^\s+|\s+$//g: å»æ‰é¦–å°¾ç©ºæ ¼
          # 3. sort -u: æ’åºå»é‡
          
          grep -r -i -h -o -E "Copyright.*[0-9]{4}.*" ./source_code \
            | sed -E 's/&amp;/\&/g; s/&#169;/(C)/g; s/&/and/g; s/ by / /g' \
            | sed -E 's/[";\\]|\\n|\\0|<[^>]*>//g' \
            | sed -E 's/\s+/ /g; s/^\s+|\s+$//g' \
            | sort -u -f > cleaned_notices.txt
          
          DISTINCT_COUNT=$(wc -l < cleaned_notices.txt)
          
          echo "============================================"
          echo "DISTINCT_COUNT: $DISTINCT_COUNT"
          echo "============================================"
          
          echo "### ğŸ“Š æœ€ç»ˆå»é‡ç»Ÿè®¡ç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "- **Distinct Copyright Occurrences**: $DISTINCT_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "*(Deep cleaning applied: removed code syntax, standardized text)*" >> $GITHUB_STEP_SUMMARY

      # 4. ç”Ÿæˆ Legal Notices æ–‡ä»¶ (åŒæ­¥ä½¿ç”¨æ¸…æ´—åçš„æ•°æ®)
      - name: Generate Legal Notices File
        run: |
          echo "FOSS Homework 3 - Legal Notices" > LEGAL_NOTICES.txt
          echo "Student Matrikelnummer: (Fill in your ID)" >> LEGAL_NOTICES.txt
          echo "Project: zlib 1.3.1" >> LEGAL_NOTICES.txt
          echo "Tool used: GitHub Actions (Syft + grep/sed/sort for deep deduplication)" >> LEGAL_NOTICES.txt
          echo "---------------------------------------------------" >> LEGAL_NOTICES.txt
          echo "" >> LEGAL_NOTICES.txt
          
          echo "DISTINCT COPYRIGHT NOTICES FOUND (CLEANED):" >> LEGAL_NOTICES.txt
          # ä½¿ç”¨ä¸Šé¢ç”Ÿæˆçš„æ¸…æ´—è¿‡çš„æ–‡ä»¶
          cat cleaned_notices.txt >> LEGAL_NOTICES.txt
          
          echo "" >> LEGAL_NOTICES.txt
          echo "---------------------------------------------------" >> LEGAL_NOTICES.txt
          echo "RAW SCAN DETAILS (Reference):" >> LEGAL_NOTICES.txt
          grep -r -i -E "Copyright.*[0-9]{4}" ./source_code >> LEGAL_NOTICES.txt
          
          echo "" >> LEGAL_NOTICES.txt
          echo "--- Full License Context from README ---" >> LEGAL_NOTICES.txt
          cat ./source_code/README >> LEGAL_NOTICES.txt

      - name: Upload Homework Files
        uses: actions/upload-artifact@v4
        with:
          name: homework-submission-files
          path: |
            zlib_sbom.spdx.json
            LEGAL_NOTICES.txt
