name: FOSS Homework Automation

on: [push, workflow_dispatch]

jobs:
  generate-files:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download zlib Source Code
        run: |
          wget --user-agent="Mozilla/5.0" https://www.zlib.net/zlib-1.3.1.tar.gz
          tar -xzvf zlib-1.3.1.tar.gz
          mv zlib-1.3.1 source_code

      - name: Generate SBOM with Syft
        uses: anchore/sbom-action@v0
        with:
          path: ./source_code
          format: spdx-json
          output-file: zlib_sbom.spdx.json

# Step 3: [修改版] 抓取所有 Copyright 行 (含无年份)
      - name: Count Distinct Copyright Notices
        id: count_copyrights
        run: |
          echo "启动 Python 智能扫描引擎 (全量抓取版)..."
          
          cat << 'EOF' > scan.py
          import os
          import re

          root_dir = './source_code'
          notices = set()
          
          # 修改点 1: 正则不再强制匹配年份，而是匹配整行
          regex = re.compile(r'(Copyright.*)(?:\r|\n|$)', re.IGNORECASE)

          for subdir, dirs, files in os.walk(root_dir):
              for file in files:
                  filepath = os.path.join(subdir, file)
                  try:
                      with open(filepath, 'r', errors='ignore') as f:
                          content = f.read()
                          
                          for match in regex.finditer(content):
                              # 修改点 2: 直接获取整行内容
                              clean = match.group(1).strip()
                              
                              # 清洗逻辑 (保持不变，用于去重)
                              clean = re.sub(r'<[\w\.-]+@[\w\.-]+>', '', clean) # 去邮箱
                              clean = re.sub(r'\(?\s*https?://\S+\s*\)?', '', clean, flags=re.IGNORECASE) # 去链接
                              clean = re.sub(r'["\';\\]', '', clean) # 去代码符号
                              clean = re.sub(r'/\*|\*/|//', '', clean) # 去注释符
                              clean = re.sub(r'<[^>]*>', '', clean) # 去标签
                              
                              # 统一公司名
                              clean = re.sub(r'Corp\.', 'Corporation', clean, flags=re.IGNORECASE)
                              
                              # 去掉末尾标点
                              clean = re.sub(r'[,.-]\s*$', '', clean)
                              clean = re.sub(r'\s+', ' ', clean).strip()
                              
                              # 过滤过短的噪音 (例如只写了 "Copyright")
                              if len(clean) > 10 and re.search(r'[a-zA-Z]', clean):
                                  notices.add(clean)
                                  
                  except Exception:
                      pass

          with open('cleaned_notices.txt', 'w') as f:
              for n in sorted(notices):
                  f.write(n + '\n')
          EOF
          
          python3 scan.py

      # Step 4: 生成文件 (包含宽松的 RAW 扫描)
      - name: Generate Legal Notices File
        run: |
          echo "FOSS Homework 3 - Legal Notices" > LEGAL_NOTICES.txt
          echo "Student Matrikelnummer: (Fill in your ID)" >> LEGAL_NOTICES.txt
          echo "Project: zlib 1.3.1" >> LEGAL_NOTICES.txt
          echo "Tool used: GitHub Actions (Python Script)" >> LEGAL_NOTICES.txt
          echo "---------------------------------------------------" >> LEGAL_NOTICES.txt
          
          echo "DISTINCT COPYRIGHT NOTICES FOUND (NORMALIZED):" >> LEGAL_NOTICES.txt
          echo "(Redundant occurrences are counted as one)" >> LEGAL_NOTICES.txt
          echo "" >> LEGAL_NOTICES.txt
          cat cleaned_notices.txt >> LEGAL_NOTICES.txt
          
          echo "" >> LEGAL_NOTICES.txt
          echo "---------------------------------------------------" >> LEGAL_NOTICES.txt
          echo "RAW SCAN DETAILS (Reference only):" >> LEGAL_NOTICES.txt
          # 修改点 3: grep 命令不再限制年份 [0-9]{4}
          grep -r -i "Copyright" ./source_code >> LEGAL_NOTICES.txt

      - name: Upload Homework Files
        uses: actions/upload-artifact@v4
        with:
          name: homework-submission-files
          path: |
            zlib_sbom.spdx.json
            LEGAL_NOTICES.txt
