name: FOSS Homework Automation

on: [push, workflow_dispatch]

jobs:
  generate-files:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # 1. ä¸‹è½½ä½œä¸šæŒ‡å®šçš„ Zlib æºç 
      - name: Download zlib Source Code
        run: |
          wget https://www.zlib.net/zlib-1.3.1.tar.gz
          tar -xzvf zlib-1.3.1.tar.gz
          mv zlib-1.3.1 source_code

      # 2. ç”Ÿæˆ SBOM (SPDX 2.3 æ ¼å¼) - å¯¹åº”ä½œä¸šè¦æ±‚
      - name: Generate SBOM with Syft
        uses: anchore/sbom-action@v0
        with:
          path: ./source_code
          format: spdx-json
          output-file: zlib_sbom.spdx.json

      # 3. ç»Ÿè®¡ç‰ˆæƒæ•°é‡ - å¯¹åº” Google Form é—®é¢˜
      - name: Count Copyright Occurrences (Refined)
        id: count_copyrights
        run: |
          echo "æ­£åœ¨è¿›è¡Œç²¾ç¡®ç‰ˆæƒæ‰«æ..."
          # è¿‡æ»¤æŽ‰ä¸åŒ…å«å¹´ä»½çš„å¼•ç”¨è¡Œ
          COUNT=$(grep -r -i -E "Copyright.*[0-9]{4}" ./source_code | wc -l)
          echo "============================================"
          echo "REFINED_COUNT: $COUNT"
          echo "============================================"
          echo "### ðŸ“Š ç²¾ç¡®ç»Ÿè®¡ç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "- **Refined Copyright Occurrences**: $COUNT" >> $GITHUB_STEP_SUMMARY

      # 4. ç”Ÿæˆ Legal Notices æ–‡ä»¶ (å‡çº§ç‰ˆï¼šåŽ»é™¤å¹²æ‰°é¡¹)
      - name: Generate Legal Notices File
        run: |
          echo "FOSS Homework 3 - Legal Notices" > LEGAL_NOTICES.txt
          echo "Student Matrikelnummer: (Fill in your ID)" >> LEGAL_NOTICES.txt
          echo "Project: zlib 1.3.1" >> LEGAL_NOTICES.txt
          # æ›´æ–°å·¥å…·æè¿°ï¼Œä½“çŽ°ä½ ä½¿ç”¨äº†è¿‡æ»¤å™¨
          echo "Tool used: GitHub Actions (Syft + grep with regex filter)" >> LEGAL_NOTICES.txt
          echo "---------------------------------------------------" >> LEGAL_NOTICES.txt
          echo "" >> LEGAL_NOTICES.txt
          
          echo "LICENSE TEXT & COPYRIGHTS:" >> LEGAL_NOTICES.txt
          
          # [å…³é”®ä¿®æ”¹] ä½¿ç”¨ -E å‚æ•°é…åˆæ­£åˆ™ï¼š
          # åªæå–åŒ…å« "Copyright" ä¸”åŒè¡ŒåŒ…å« 4 ä½æ•°å­—(å¹´ä»½) çš„è¡Œ
          grep -r -i -E "Copyright.*[0-9]{4}" ./source_code >> LEGAL_NOTICES.txt
          
          echo "" >> LEGAL_NOTICES.txt
          echo "--- Full License Context from README ---" >> LEGAL_NOTICES.txt
          cat ./source_code/README >> LEGAL_NOTICES.txt

      # 5. æ‰“åŒ…æ–‡ä»¶ä¾›ä¸‹è½½
      - name: Upload Homework Files
        uses: actions/upload-artifact@v4
        with:
          name: homework-submission-files
          path: |
            zlib_sbom.spdx.json
            LEGAL_NOTICES.txt
