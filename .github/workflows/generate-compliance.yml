name: FOSS Homework Automation

on: [push, workflow_dispatch]

jobs:
  generate-files:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download zlib Source Code
        run: |
          wget --user-agent="Mozilla/5.0" https://www.zlib.net/zlib-1.3.1.tar.gz
          tar -xzvf zlib-1.3.1.tar.gz
          mv zlib-1.3.1 source_code

      - name: Generate SBOM with Syft
        uses: anchore/sbom-action@v0
        with:
          path: ./source_code
          format: spdx-json
          output-file: zlib_sbom.spdx.json

      # Step 3: [é‡åˆ¶ç‰ˆ] æ™ºèƒ½å»é‡ç»Ÿè®¡ (é’ˆå¯¹ README ä¼˜åŒ–)
      - name: Count Distinct Copyright Notices
        id: count_copyrights
        run: |
          echo "å¯åŠ¨ Python æ™ºèƒ½æ‰«æå¼•æ“ (README ä¼˜åŒ–ç‰ˆ)..."
          
          cat << 'EOF' > scan.py
          import os
          import re

          root_dir = './source_code'
          notices = set()
          
          # æ­£åˆ™è®¾è®¡æ€è·¯ï¼š
          # 1. é”šç‚¹: "Copyright" (å¿½ç•¥å¤§å°å†™)
          # 2. é—´éš”: [^0-9]*? -> å…è®¸ä¸­é—´å‡ºç° (c), (C), by, ç©ºæ ¼, ç”šè‡³ä»£ç ç¬¦å·ï¼Œç›´åˆ°é‡åˆ°æ•°å­—
          # 3. æ ¸å¿ƒ: ((?:19|20)\d{2}.*?) -> æŠ“å– 19xx æˆ– 20xx å¼€å¤´çš„å¹´ä»½ï¼Œä»¥åŠåé¢æ‰€æœ‰å†…å®¹
          # 4. è¾¹ç•Œ: (?:\r|\n|$) -> åŒ¹é…åˆ°è¡Œå°¾
          regex = re.compile(r'Copyright[^0-9]*?((?:19|20)\d{2}.*?)(?:\r|\n|$)', re.IGNORECASE)

          for subdir, dirs, files in os.walk(root_dir):
              for file in files:
                  filepath = os.path.join(subdir, file)
                  try:
                      # å¿½ç•¥äºŒè¿›åˆ¶æ–‡ä»¶å’Œéæ–‡æœ¬æ–‡ä»¶
                      with open(filepath, 'r', errors='ignore') as f:
                          content = f.read()
                          
                          for match in regex.finditer(content):
                              # è¿™é‡ŒæŠ“åˆ°çš„æ˜¯ "å¹´ä»½ + ä½œè€…" (ä¾‹å¦‚ "1995-2024 Jean-loup Gailly")
                              raw_body = match.group(1)
                              
                              # æ‹¼æ¥æˆæ ‡å‡†å¤´ï¼Œæ–¹ä¾¿ç»Ÿä¸€å¤„ç†
                              full_text = "Copyright " + raw_body
                              
                              # === å¼ºåŠ›å½’ä¸€åŒ– (Normalization) ===
                              # åªæœ‰æŠŠä¸åŒæ ¼å¼æ´—æˆä¸€æ ·çš„ï¼Œæ‰èƒ½å®ç° "Redundant counted as one"
                              
                              # 1. ç§»é™¤ URL å’Œ é‚®ç®± (é€šå¸¸æ˜¯å™ªéŸ³ï¼Œå¯¼è‡´æœ¬è¯¥é‡å¤çš„è¡Œå˜å¾—ä¸åŒ)
                              # ç§»é™¤ <email@address>
                              clean = re.sub(r'<[\w\.-]+@[\w\.-]+>', '', full_text)
                              # ç§»é™¤ (http://...) æˆ– http://...
                              clean = re.sub(r'\(?\s*https?://\S+\s*\)?', '', clean, flags=re.IGNORECASE)
                              clean = re.sub(r'\(?\s*www\.\S+\s*\)?', '', clean, flags=re.IGNORECASE)
                              
                              # 2. ç§»é™¤ä»£ç å™ªéŸ³ (é’ˆå¯¹ .c .h .rc æ–‡ä»¶)
                              clean = re.sub(r'["\';\\]', '', clean)  # å»æ‰å¼•å·ã€åˆ†å·
                              clean = re.sub(r'/\*|\*/|//', '', clean) # å»æ‰æ³¨é‡Šç¬¦
                              clean = re.sub(r'<[^>]*>', '', clean)    # å»æ‰ XML/HTML æ ‡ç­¾
                              
                              # 3. ç§»é™¤å¸¸è§ä¿®é¥°è¯ï¼Œç»Ÿä¸€æ ¼å¼
                              clean = re.sub(r'\(c\)', '', clean, flags=re.IGNORECASE) # å»æ‰ (c)
                              clean = re.sub(r'\s+by\s+', ' ', clean, flags=re.IGNORECASE) # å»æ‰ by
                              clean = re.sub(r'All rights reserved', '', clean, flags=re.IGNORECASE)
                              
                              # 4. å…³é”®ï¼šç»Ÿä¸€å…¬å¸åç§°æ‹¼å†™
                              # è¿™æ · "Borland Corp." å’Œ "Borland Corporation" å°±ä¼šç®—ä½œåŒä¸€ä¸ª
                              clean = re.sub(r'Corp\.', 'Corporation', clean, flags=re.IGNORECASE)
                              
                              # 5. å»æ‰é¦–å°¾æ ‡ç‚¹ (å¥å·, é€—å·) å’Œå¤šä½™ç©ºæ ¼
                              # è¿™æ · "Mark Adler." å’Œ "Mark Adler" å°±ä¼šç®—ä½œåŒä¸€ä¸ª
                              clean = re.sub(r'[,.-]\s*$', '', clean)
                              clean = re.sub(r'\s+', ' ', clean).strip()
                              
                              # 6. æœ€ç»ˆè¿‡æ»¤ï¼š
                              # - é•¿åº¦é™åˆ¶ (é˜²æ­¢æŠ“åˆ°é•¿ç¯‡å¤§è®º)
                              # - å¿…é¡»åŒ…å«å­—æ¯ (é˜²æ­¢åªæŠ“åˆ° "Copyright 1995")
                              if len(clean) < 150 and re.search(r'[a-zA-Z]', clean):
                                  notices.add(clean)
                                  
                  except Exception:
                      pass

          # æ’åºå¹¶è¾“å‡º
          with open('cleaned_notices.txt', 'w') as f:
              for n in sorted(notices):
                  f.write(n + '\n')
          EOF
          
          # è¿è¡Œè„šæœ¬
          python3 scan.py
          
          # ç»Ÿè®¡è¡Œæ•°
          DISTINCT_COUNT=$(wc -l < cleaned_notices.txt)
          
          echo "============================================"
          echo "FINAL DISTINCT COUNT: $DISTINCT_COUNT"
          echo "============================================"
          
          echo "### ğŸ“Š æœ€ç»ˆç»Ÿè®¡ç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "- **Distinct Copyright Occurrences**: $DISTINCT_COUNT" >> $GITHUB_STEP_SUMMARY

      # Step 4: ç”Ÿæˆæ–‡ä»¶
      - name: Generate Legal Notices File
        run: |
          echo "FOSS Homework 3 - Legal Notices" > LEGAL_NOTICES.txt
          echo "Student Matrikelnummer: (Fill in your ID)" >> LEGAL_NOTICES.txt
          echo "Project: zlib 1.3.1" >> LEGAL_NOTICES.txt
          echo "Tool used: GitHub Actions (Python Normalization for Distinct Count)" >> LEGAL_NOTICES.txt
          echo "---------------------------------------------------" >> LEGAL_NOTICES.txt
          echo "" >> LEGAL_NOTICES.txt
          
          echo "DISTINCT COPYRIGHT NOTICES FOUND (NORMALIZED):" >> LEGAL_NOTICES.txt
          echo "(Redundant occurrences are counted as one)" >> LEGAL_NOTICES.txt
          echo "" >> LEGAL_NOTICES.txt
          # å†™å…¥æ¸…æ´—åçš„å»é‡åˆ—è¡¨
          cat cleaned_notices.txt >> LEGAL_NOTICES.txt
          
          echo "" >> LEGAL_NOTICES.txt
          echo "---------------------------------------------------" >> LEGAL_NOTICES.txt
          echo "IMPORTANT: REFERENCE FROM README FILE:" >> LEGAL_NOTICES.txt
          # ä¸“é—¨æŠŠ README é‡Œçš„ç‰ˆæƒéƒ¨åˆ†æå–å‡ºæ¥å±•ç¤ºï¼Œå“åº”é¢˜ç›®è¦æ±‚
          grep -A 20 "Copyright notice:" ./source_code/README >> LEGAL_NOTICES.txt
          
          echo "" >> LEGAL_NOTICES.txt
          echo "---------------------------------------------------" >> LEGAL_NOTICES.txt
          echo "RAW SCAN DETAILS (Reference only):" >> LEGAL_NOTICES.txt
          grep -r -i -E "Copyright.*[0-9]{4}" ./source_code >> LEGAL_NOTICES.txt

      - name: Upload Homework Files
        uses: actions/upload-artifact@v4
        with:
          name: homework-submission-files
          path: |
            zlib_sbom.spdx.json
            LEGAL_NOTICES.txt
